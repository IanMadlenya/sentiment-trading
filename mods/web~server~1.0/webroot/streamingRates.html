
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Streaming FX Rates from OANDA</title>

    <!-- Bootstrap core CSS -->
    <link href="./css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="./css/cover.css" rel="stylesheet">

    <script type="text/javascript" src="./js/smoothie.js"></script>
  </head>

  <body>

    <div class="site-wrapper">

      <div class="site-wrapper-inner">

        <div class="cover-container">

          <div class="masthead clearfix">
            <div class="inner">
              <h3 class="masthead-brand">Cover</h3>
              <nav>
                <ul class="nav masthead-nav">
                  <li><a href="./index.html">Home</a></li>
                  <li class="active"><a href="./streamingRates.html">Streaming Rates</a></li>
                  <li><a href="#">Contact</a></li>
                </ul>
              </nav>
            </div>
          </div>

          <div class="inner" id="rateGraphs">
            <!-- <p>EUR_USD</p>
            <p>
              <canvas id="eur_usd" width="600" height="100"></canvas>
            </p> -->
          </div>

          <div class="mastfoot">
            <div class="inner">
              <p>Cover template for <a href="http://getbootstrap.com">Bootstrap</a>, by <a href="https://twitter.com/mdo">@mdo</a>.</p>
            </div>
          </div>

        </div>

      </div>

    </div>

    <script type="text/javascript">
      var connection = new WebSocket('ws://' + location.hostname + ':' + location.port);
      connection.onmessage = tickReceived;
      console.log("created websocket");

      var graphs = new Map();

      function tickReceived(tickMessage) {
        var tick = JSON.parse(tickMessage.data);
        // console.log(tick);
        // if (tick.instrument === "EUR_USD") {
          if (!graphs.has(tick.instrument)) {
            console.log("adding new graph section for: "+tick.instrument);

            var graphElement = document.getElementById("rateGraphs");
            var newGraphDiv = document.createElement("div");

            var titleDiv = document.createElement("div");
            var title = document.createTextNode(tick.instrument);
            titleDiv.appendChild(title);

            var graphDiv = document.createElement("div");
            var graphCanvas = document.createElement("canvas");
            graphCanvas.setAttribute("id", tick.instrument);
            graphCanvas.setAttribute("width", 600);
            graphCanvas.setAttribute("height", 150);
            graphDiv.appendChild(graphCanvas);

            newGraphDiv.appendChild(titleDiv);
            newGraphDiv.appendChild(graphDiv);

            graphElement.appendChild(newGraphDiv);

            var ts = {
              bid: new TimeSeries(),
              ask: new TimeSeries()
            };

            graphs.set(tick.instrument, ts);

            var smoothie = new SmoothieChart({ grid: { strokeStyle: 'rgb(125, 0, 0)', fillStyle: 'rgb(60, 0, 0)', lineWidth: 1, millisPerLine: 1000, verticalSections: 6 },
              labels: { precision: 4} ,
              millisPerPixel:50});
            smoothie.addTimeSeries(ts.bid, { strokeStyle: 'rgb(0, 255, 0)', fillStyle: 'rgba(0, 255, 0, 0.4)', lineWidth: 3 });
            smoothie.addTimeSeries(ts.ask, { strokeStyle: 'rgb(255, 0, 255)', fillStyle: 'rgba(255, 0, 255, 0.3)', lineWidth: 3 });

            smoothie.streamTo(document.getElementById(tick.instrument), 1000);
          }

          console.log("got eur usd tick: " + tick.bid + ' ' + tick.ask);
          var timeSeries = graphs.get(tick.instrument);
          timeSeries.bid.append(new Date().getTime(), tick.bid);
          timeSeries.ask.append(new Date().getTime(), tick.ask);
        // }
      }


    </script>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>

  </body>
</html>
